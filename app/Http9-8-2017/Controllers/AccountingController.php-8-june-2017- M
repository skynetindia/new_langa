<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Repositories\AccountingRepository;
use App\Repositories\ProjectRepository;
use DB;
use Validator;
use Redirect;
use App\Http\Requests;
use App\Accounting;
use App\PDF\fpdf;
use Storage;
use DateTime;
use App\Classes\PdfWrapper as PDF;

class AccountingController extends Controller
{
    protected $pagamenti;
	protected $progetti;
	protected $logmainsection;
    
    public function __construct(AccountingRepository $accountings, ProjectRepository $projects)
    {
        $this->middleware('auth');
        $this->pagamenti = $accountings;
		$this->progetti = $projects;
		$this->logmainsection = 'Accounting';
		
    }
	
	
	public function elencotranche(Request $request)
	{
		// if ($request->user()->id === 0 || $request->user()->dipartimento === 1)			
			return view('pagamenti.elencotranche');
		// else
			// return redirect('/unauthorized');
	}

	public function getjsontuttetranche(Request $request)
	{
		// $tranche = DB::table('tranche')->get();

		$tranche = DB::table('tranche')
				->join('users', 'tranche.user_id','=','users.id')
				->select(DB::raw('tranche.*, users.id as uid, users.is_delete'))
				->where('users.is_delete', '=', 0)
				->get();

		foreach($tranche as $tr) {
			if($tr->is_deleted == 0)
				$tranche_return[] = $tr;	
		}
		$tranche_return = $this->aggiungiNomeQuadro($tranche_return, $request->user());
		return json_encode($tranche_return);
	}

	public function aggiungiNomeQuadro(&$tranche, $user)
	{
		$elenco_tranche = [];
		foreach($tranche as $tra) {
			if($tra->tipo == 1) {
				$tra->tipo = "Rinnovo";
			} else {
				$tra->tipo = "Pagamento";
			}
			$tra->ente = DB::table('corporations')
				->where('id', $tra->A)
				->first()->nomeazienda;
			$disposizione = DB::table('accountings')
							->where('id', $tra->id_disposizione)
							->first();
			$tra->nomequadro = $disposizione->nomeprogetto;
			$stato = DB::table('statipagamenti')
						->where('id_pagamento', $tra->id)
						->first();
			if($stato) {
				$statoemotivo = DB::table('statiemotivipagamenti')
								->where('id', $stato->id_tipo)
								->first();
						
				$tra->statoemotivo = '<span style="color:'.$statoemotivo->color.'">'.$statoemotivo->name.'</span>';			
				
			}
			if ($user->id === 0 || $user->dipartimento === 1) {
            	$elenco_tranche[] = $tra;
        	} else if($user->id == $tra->user_id) {
				$elenco_tranche[] = $tra;	
			}
		}
		return $elenco_tranche;
	}
	
	public function modificatranche(Request $request)
	{
		$tranche = DB::table('tranche')
			->where('id', $request->id)
			->first();

		return view('pagamenti.modificatranche', [
			'tranche' => $tranche,
			'utenti' => DB::table('users')
				->get(),
			'enti' => DB::table('corporations')
				->orderBy('id', 'asc')
				->get(),
			'statiemotivi' => DB::table('statiemotivipagamenti')
				->get(),
			'statoemotivoselezionato' => DB::table('statipagamenti')
				->where('id_pagamento', $tranche->id)
				->first(),
		]);
	}
	
	public function generapdftranche(Request $request)
	{
		$idtranche = $request->id;
		$tranche = DB::table('tranche')
			->where('id', $idtranche)
			->first();

		$user = $request->user();
		
		if(!$this->hasPower($user, $tranche)) {
			return redirect('/unauthorized');
		}
		$ente_DA = DB::table('corporations')
					->where('id', $tranche->DA)
					->first();					
		$disposizione = DB::table('accountings')
							->where('id', $tranche->id_disposizione)
							->first();
		/*$corpofattura = json_decode(json_encode(DB::table('corpofattura')
							->where('id_tranche', $idtranche)
							->orderBy('ordine_numerico', 'asc')
							->get()), true);*/
		$corpofattura = DB::table('corpofattura')
							->where('id_tranche', $idtranche)
							->orderBy('ordine_numerico', 'asc')
							->get();
		$ente_A = DB::table('corporations')
					->where('id', $tranche->A)
					->first();

		$pdf = new PDF('utf-8');
		$pdf->mirrorMargins(1);
						
		//$header = \View::make('pdf.quotation_header')->render();		
		$footer = \View::make('pdf.invoice_footer')->render();
		
		//$pdf->SetHTMLHeader($header, 'O');
		//$pdf->SetHTMLHeader($header, 'E');
		$pdf->SetHTMLFooter($footer, 'O');
		$pdf->SetHTMLFooter($footer, 'E');
		$pdf->AddPage('P', 10, 10, 38, 20, 8, 2, 'A4-L');

		$id_perfile = substr($tranche->idfattura, 0, 5) . '-' . substr($tranche->idfattura, 6);
		$pdf->SetTitle($id_perfile . '_' . $disposizione->nomeprogetto . '_LANGA Group');
		
		$pdf->loadView('pdf.invoice', [
			'ente_DA' => $ente_DA,
			'ente_A'=>$ente_A,
			'disposizione'=>$disposizione,
			'corpofattura'=>$corpofattura,
			'tranche'=>$tranche]);

		$logs = $this->logmainsection.' -> Generate pdf for Invoice (ID: '. $request->id . ')';
		storelogs($request->user()->id, $logs);		

		/*$pdf->download('test.pdf');*/
		$pdf->stream($id_perfile . '_' . $disposizione->nomeprogetto . '_LANGA Group' . '.pdf');							
	}

	public function stampaTesto(&$pdf, $x, $y, $testo, $larghezza, $allineamento, $spessore, $family, $type, $size)
	{
		$pdf->SetFont($family, $type, $size);
		$array = explode("\n", $testo);
		
		for($i = 0; $i < count($array); $i++) {
			$pdf->SetXY($x, $y + $i * $spessore);
			$pdf->Cell($larghezza, 0, $array[$i], 0, 1, $allineamento);
		}
	}

	public function hasPower($user, $accounting)
	{
		if ($user->id === 0 || $user->dipartimento === "AMMINISTRAZIONE") {
            return true;
    	}
    	return $accounting->user_id === $user->id;
	}

	public function salvatranche(Request $request)
	{
		$validator = Validator::make($request->all(), [
			'DA' => 'required',
			'A' => 'required',
			'datascadenza' => 'required',
			'percentuale' => 'required',
			'emissione' => 'required',
			'tipofattura' => 'required',
			'base' => 'required',
        ]);
        
        if($validator->fails()) {
            return Redirect::back()
                ->withInput()
                ->with('error_code', 6)
                ->withErrors($validator);
        }
		
		// Controllo lo sconto e lo sconto bonus
		if(isset($request->ordine)) {
			$scontoagente = $request->scontoagente;
			$scontobonus = $request->scontobonus;
			$scontibonus = [];
			// Seleziono l'ente relativo alla utenza in uso
			$ente = DB::table('corporations')
						->where('id', $request->user()->id_ente)
						->first();
	
			$elenco = DB::table('corporationtypes')
						->where('id_ente', $ente->id)
						->get();
			// Variabile per contenere gli sconto assegnati a quell'ente
			$sconti = [];
			// Per tutti i tipi assegnati a quell'ente
			for($i = 0; $i < count($elenco); $i++) {
				$sc = DB::table('entisconti')
							->where('id_sconto', $elenco[$i]->id_tipo)
							->first();
				if($sc)
				$sconto = DB::table('sconti')
							->where('id', $sc->id_sconto)
							->first();
				if(isset($sconto))		
				$sconti[] = $sconto->sconto;
			}
			$max = 0;
			for($i = 0; $i < count($sconti); $i++) {
				if($max < $sconti[$i])
					$max = $sconti[$i];
			}
			$scontoagente_max = $max;
			// Sconto bonus
			$elenco = DB::table('entiscontibonus')
						->where('id_tipo', $request->user()->id)
						->get();
			$sconti = [];
			for($i = 0; $i < count($elenco); $i++) {
				$sconto = DB::table('scontibonus')
							->where('id', $elenco[$i]->id_sconto)
							->first();
				if($sconto)
				$scontibonus[] = $sconto->sconto;
			}
			$max = 0;
			for($i = 0; $i < count($scontibonus); $i++) {
				if($max < $scontibonus[$i])
					$max = $scontibonus[$i];
			}
			$scontobonus_max = $max;
			for($i = 0; $i < count($scontoagente); $i++) {
				if($scontoagente[$i] > $scontoagente_max) {
					return Redirect::back()
						->withInput()
                        ->with('msg', '<div class="alert alert-danger"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>Non ti è permesso imporre uno sconto agente maggiore a ' . $scontoagente_max . '</div>');
				} else if($scontobonus[$i] > $scontobonus_max) {
					return Redirect::back()
						->withInput()
                        ->with('msg', '<div class="alert alert-danger"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>Non ti è permesso imporre uno sconto bonus maggiore a ' . $scontobonus_max . '</div>');	
				}
			}
		}
					  
		if($request->tipofattura == 0) {
			$tipofattura = "FATTURA DI VENDITA";	
		} else {
			$tipofattura = "NOTA DI CREDITO";	
		}
		
		$tranche = DB::table('tranche')->insertGetId([
                        'user_id' => $request->user()->id,
                        'id_disposizione' => $request->id_disposizione,
						'tipo' => $request->tipo,
						'datainserimento' => isset($request->datainserimento) ? $request->datainserimento : '',
						'datascadenza' => $request->datascadenza,
						'percentuale' => $request->percentuale,
						'dettagli' => isset($request->dettagli) ? $request->dettagli : '',
						'frequenza' => $request->frequenza,
						'DA' => $request->DA,
						'A' => $request->A,
						'idfattura' => isset($request->idfattura) ? $request->idfattura : '',
						'emissione' => $request->emissione,
						'indirizzospedizione' => $request->indirizzospedizione,
						'privato' => $request->privato,
						'testoimporto' => $request->importo_nopercentuale,
						'base' => $request->base,
						'modalita' => isset($request->modalita) ? $request->modalita : '',
						'tipofattura' => $tipofattura,
						'iban' => isset($request->iban) ? $request->iban : '',
						'peso' => isset($request->peso) ? $request->peso : '',
						'netto' => isset($request->netto) ? $request->netto : '',
						'scontoaggiuntivo' => isset($request->scontoaggiuntivo) ? $request->scontoaggiuntivo : '',
						'imponibile' => isset($request->imponibile) ? $request->imponibile : '',
						'prezzoiva' => isset($request->prezzoiva) ? $request->prezzoiva : '',
						'percentualeiva' => isset($request->percentualeiva) ? $request->percentualeiva : '',
						'dapagare' => isset($request->dapagare) ? $request->dapagare : '',
                      ]);
		
		$logs = $this->logmainsection.' -> Add New Invoice (ID: '. $tranche . ')';
		storelogs($request->user()->id, $logs);

		if($request->statoemotivo!=null) {
			// Memorizzo lo stato emotivo
			$tipo = DB::table('statiemotivipagamenti')
				->where('name', $request->statoemotivo)
				->first();
			DB::table('statipagamenti')->insert([
				'id_pagamento' => $tranche,
				'id_tipo' => $tipo->id,
			]);
		}
		
		// Salvo il corpo fattura
		if(isset($request->ordine)) {
			$ordine = isset($request->ordine) ? $request->ordine : 0;
			$descrizione = $request->desc;
			$qt = $request->qt;
			$subtotale = $request->subtotale;
			$scontoagente = isset($request->scontoagente) ? $request->scontoagente : 0;
			$scontobonus = $request->scontobonus;
			$prezzonetto = $request->prezzonetto;
			$iva = $request->iva;
			for($i = 0; $i < count($ordine); $i++) {
				DB::table('corpofattura')->insert([
					'id_tranche' => $tranche,
					'ordine' => $ordine[$i],
					'descrizione' => isset($descrizione[$i]) ? $descrizione[$i] : 0,
					'qta' => isset($qt[$i]) ? $qt[$i] : 0,
					'subtotale' => isset($subtotale[$i]) ? $subtotale[$i] : 0,
					'scontoagente' => isset($scontoagente[$i]) ? $scontoagente[$i] : 0 ,
					'scontobonus' => $scontobonus[$i],
					'netto' => isset($prezzonetto[$i]) ? $prezzonetto[$i] : 0,
					'percentualeiva' => isset($iva[$i]) ? $iva[$i] : 0,
				]);
			}
		}
					  
		return redirect('/pagamenti/mostra/accounting/' . $request->id_disposizione)
                        ->with('error_code', 5)
                        ->with('msg', '<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a> '.trans('messages.keyword_addsuccessmsg').'!</div>');
	}


	public function aggiornatranche(Request $request)
	{
		$validator = Validator::make($request->all(), [			
			'DA' => 'required',
			'A' => 'required',
			'datascadenza' => 'required',
			'percentuale' => 'required',
			'emissione' => 'required',
			'tipofattura' => 'required',
			'base' => 'required'
        ]);        
        
        if($validator->fails()) {
            return Redirect::back()
                ->withInput()
                ->with('error_code', 6)
                ->withErrors($validator);
        }
		
		// Controllo lo sconto e lo sconto bonus
		if(isset($request->ordine)) {
			$scontoagente = isset($request->scontoagente) ? $request->scontoagente : 0;
			$scontobonus = $request->scontobonus;
			$scontibonus = [];
			// Seleziono l'ente relativo alla utenza in uso
			$ente = DB::table('corporations')
						->where('id', $request->user()->id_ente)
						->first();
	
			$elenco = DB::table('corporationtypes')
						->where('id_ente', $ente->id)
						->get();

			// Variabile per contenere gli sconto assegnati a quell'ente
			$sconti = [];
			// Per tutti i tipi assegnati a quell'ente
			for($i = 0; $i < count($elenco); $i++) {
				$sc = DB::table('entisconti')
							->where('id_sconto', $elenco[$i]->id_tipo)
							->first();
				if($sc)
				$sconto = DB::table('sconti')
							->where('id', $sc->id_sconto)
							->first();
				if(isset($sconto))
				$sconti[] = $sconto->sconto;
			}
			$max = 0;
			for($i = 0; $i < count($sconti); $i++) {
				if($max < $sconti[$i])
					$max = $sconti[$i];
			}
			$scontoagente_max = $max;
			// Sconto bonus
			$elenco = DB::table('entiscontibonus')
						->where('id_tipo', $request->user()->id)
						->get();
			$sconti = [];
			for($i = 0; $i < count($elenco); $i++) {
				$sconto = DB::table('scontibonus')
							->where('id', $elenco[$i]->id_sconto)
							->first();
				if($sconto)
				$scontibonus[] = $sconto->sconto;
			}
			$max = 0;
			for($i = 0; $i < count($scontibonus); $i++) {
				if($max < $scontibonus[$i])
					$max = $scontibonus[$i];
			}
			$scontobonus_max = $max;
			for($i = 0; $i < count($scontoagente); $i++) {
				if($scontoagente[$i] > $scontoagente_max) {
					return Redirect::back()
						->withInput()
                        ->with('msg', '<div class="alert alert-danger"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'.trans('messages.keyword_arenotallowed_impose_agent_discount').' ' . $scontoagente_max . '</div>');
				} else if($scontobonus[$i] > $scontobonus_max) {
					return Redirect::back()
						->withInput()
                        ->with('msg', '<div class="alert alert-danger"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'.trans('messages.keyword_arenotallowed_impose_bonus').' ' . $scontobonus_max . '</div>');	
				}
			}
		}
		
		$iddisposizione = DB::table('tranche')
							->where('id', $request->id)
							->first();
		
		if($request->tipofattura == 0) {
			$tipofattura = "FATTURA DI VENDITA";	
		} else {
			$tipofattura = "NOTA DI CREDITO";	
		}
		
		$tranche = DB::table('tranche')
					->where('id', $request->id)
					->first();
		
		DB::table('notifiche')
			->where('id', $tranche->id_notifica)
			->delete();
		
		DB::table('tranche')
			->where('id', $request->id)
			->update(array(
            	'user_id' => $request->user()->id,
				'tipo' => $request->tipo,
				'datainserimento' => isset($request->datainserimento) ? $request->datainserimento : '',
				'datascadenza' => $request->datascadenza,
				'percentuale' => $request->percentuale,
				'dettagli' => $request->dettagli,
				'frequenza' => $request->frequenza,
				'DA' => $request->DA,
				'A' => $request->A,
				'idfattura' => $request->idfattura,
				'emissione' => $request->emissione,
				'indirizzospedizione' => $request->indirizzospedizione,
				'testoimporto' => $request->importo_nopercentuale,
				'id_notifica' => 0,
				'privato' => $request->privato,
				'base' => $request->base,
				'modalita' => $request->modalita,
				'tipofattura' => $tipofattura,
				'iban' => $request->iban,
				'peso' => $request->peso,
				'netto' => $request->netto,
				'scontoaggiuntivo' => $request->scontoaggiuntivo,
				'imponibile' => $request->imponibile,
				'prezzoiva' => $request->prezzoiva,
				'percentualeiva' => $request->percentualeiva,
				'dapagare' => $request->dapagare,
        ));
		

		$logs = $this->logmainsection.' -> Update Invoice (ID: '. $request->id . ')';
		storelogs($request->user()->id, $logs);


		if($request->statoemotivo!=null) {
			// Aggiorno lo stato emotivo
			$tipo = DB::table('statiemotivipagamenti')
				->where('name', $request->statoemotivo)
				->first();
			DB::table('statipagamenti')
				->where('id_pagamento', $request->id)
				->delete();
			DB::table('statipagamenti')
				->insert([
					'id_tipo' => $tipo->id,
					'id_pagamento' => $request->id
				]);
		}
		

		// Aggiorno il corpo fattura
		if(isset($request->ordine)) {
			$ordine = $request->ordine;
			$descrizione = $request->desc;
			$qt = $request->qt;
			$subtotale = $request->subtotale;
			$scontoagente = isset($request->scontoagente) ? $request->scontoagente : 0;
			$prezzonetto = $request->prezzonetto;
			$iva = $request->iva;
			for($i = 0; $i < count($ordine); $i++) {
				DB::table('corpofattura')->insert([
					'id_tranche' => $request->id,
					'ordine' => $ordine[$i],					
					'descrizione' => isset($descrizione[$i]) ? $descrizione[$i] : '',
					'qta' => isset($qt[$i]) ? $qt[$i] : '',
					'subtotale' => isset($subtotale[$i]) ? $subtotale[$i] : '',
					'scontoagente' => isset($request->scontoagente[$i]) ? $request->scontoagente[$i] : 0,
					'netto' => isset($request->prezzonetto[$i]) ? $request->prezzonetto[$i] : 0,
					'percentualeiva' => isset($request->iva[$i]) ? $request->iva[$i] : 0,
				]);
			}
		}
					  
		return redirect('/pagamenti/mostra/accounting/' . $iddisposizione->id_disposizione)
                        ->with('msg', '<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a> '.trans('messages.keyword_modified_layout_correctly').' !</div>');
	}

	public function mostradisposizione(Request $request, Accounting $accounting)
	{

		$this->authorize('mostra', $accounting);

		return view('pagamenti.mostra', [
			'idfattura' => $accounting->id
		]);
	}

	public function aggiungitranche(Request $request)
    {
        return $this->aggiungi($request);
    }

    public function aggiungi(Request $request)
    {
		if ($request->user()->id === 0 || $request->user()->dipartimento !== "TECNICO") {
			 
			 $disposizione = DB::table('accountings')
			 				->where('id', $request->id)
							->first();

			 $progetto = DB::table('projects')
			 				->where('id', $disposizione->id_progetto)
							->first();

			 $preventivo = DB::table('quotes')
			 				->where('id', $progetto->id_preventivo)
							->first();
			 if($preventivo) {
				$corpofattura = DB::table('optional_preventivi')
					->where('id_preventivo', $preventivo->id)
					->get();
				$ordine = $preventivo->id;
				$anno = $preventivo->anno;
				$prev = DB::table('quotes')->where('id', $preventivo->id)->first();
				$sconto = $prev->scontoagente;
				$scontobonus = $prev->scontobonus;
			 } else {
			 	$ordine = null;
				$anno = null;
				$corpofattura = null;
				$sconto = null;
				$scontobonus = null;
			 }
             return view('pagamenti.aggiungitranche', [
				'utenti' => DB::table('users')
							->get(),
				'progetti' => $this->progetti->forUser2($request->user()), 
				'enti' => DB::table('corporations')
							->orderBy('id', 'asc')
							->get(),
				'idfattura' => $request->id,
				'statiemotivi' => DB::table('statiemotivipagamenti')
									->get(),
				'preventiviconfermati' => DB::table('quotes')
            					->where('legameprogetto', 1)
								->having('usato', '=', 0)
            					->get(),
				'corpofattura' => $corpofattura,
				'ordine' => $ordine,
				'anno' => $anno,
				'sconto' => $sconto,
				'scontobonus' => $scontobonus
        	]);
        } else {
			return view('errors.403');
		}
    }

    public function getjsontranche(Request $request)
	{
		$tranche = DB::table('tranche')
			->where('id_disposizione', $request->id)
			->get();
			
		foreach($tranche as $tr) {
			if($tr->is_deleted == 0)
				$tranche_return[] = $tr;	
		}
		$this->compilaTranche($tranche_return);
		return json_encode($tranche_return);
	}

	public function compilaTranche(&$tranche)
	{
		foreach($tranche as $tra) {
			if($tra->tipo == 1) {
				$tra->tipo = "Rinnovo";
			} else {
				$tra->tipo = "Pagamento";
			}
			$tra->ente = DB::table('corporations')
				->where('id', $tra->A)
				->first()->nomeazienda;
			// Compilo lo stato emotivo
			$stato = DB::table('statipagamenti')
						->where('id_pagamento', $tra->id)
						->first();
			if($stato) {
				$statoemotivo = DB::table('statiemotivipagamenti')
								->where('id', $stato->id_tipo)
								->first();
						
				$tra->statoemotivo = $statoemotivo->name;
			}
		}
	}

	public function fileupload(Request $request){
	
		Storage::put(
				'images/invoice/' . $request->file('file')->getClientOriginalName(), file_get_contents($request->file('file')->getRealPath())
		);
		
		$nome = $request->file('file')->getClientOriginalName();			
			DB::table('media_files')->insert([
			'name' => $nome,
			'code' => $request->code,
			'master_type' => 3,
			'type'=>$request->user()->dipartimento,
			'master_id' => isset($request->idtranche) ? $request->idtranche : 0
		]);					
	}

	public function fileget(Request $request){
		
		if(isset($request->quote_id)){
			$updateData = DB::table('media_files')->where('quote_id', $request->quote_id)->get();										
		}
		else {
			$updateData = DB::table('media_files')->where('code', $request->code)->get();				
		}					
		foreach($updateData as $prev) {
			$imagPath = url('/storage/app/images/invoice/'.$prev->name);
			$html = '<tr class="quoteFile_'.$prev->id.'"><td><img src="'.$imagPath.'" height="100" width="100"><a class="btn btn-danger pull-right" style="text-decoration: none; color:#fff" onclick="deleteQuoteFile('.$prev->id.')"><i class="fa fa-trash"></i></a></td></tr>';
			$html .='<tr class="quoteFile_'.$prev->id.'"><td>';
			$utente_file = DB::table('ruolo_utente')->select('*')->where('is_delete', 0)->get();							
			foreach($utente_file as $key => $val){
				if($request->user()->dipartimento == $val->ruolo_id){
					$response = DB::table('media_files')->where('id', $prev->id)->update(array('type' => $val->ruolo_id));	    
					$html .=' <div class="cust-radio"><input type="radio" checked="checked" name="rdUtente_'.$prev->id.'" id="'.$val->nome_ruolo.'_'.$val->ruolo_id.'" onchange="updateType('.$val->ruolo_id.','.$prev->id.');"  value="'.$val->ruolo_id.'" /><label for="'.$val->nome_ruolo.'_'.$val->ruolo_id.'"> '.$val->nome_ruolo.'</label><div class="check"><div class="inside"></div></div></div>';
				}
				else {
					$html .=' <div class="cust-radio"><input type="radio" name="rdUtente_'.$prev->id.'" id="'.$val->nome_ruolo.'_'.$prev->id.'" onchange="updateType('.$val->ruolo_id.','.$prev->id.');"  value="'.$val->ruolo_id.'" /><label for="'.$val->nome_ruolo.'_'.$prev->id.'"> '.$val->nome_ruolo.'</label><div class="check"><div class="inside"></div></div></div>';
				}
			}
			echo $html .='</td></tr>';
		}
		exit;			
	}

	public function filedelete(Request $request){
		
	    $response = DB::table('media_files')->where('id', $request->id)->delete();
		if($response){
			echo 'success';
		}
		else {
			echo 'fail';
		}
		exit;
	}

	public function filetypeupdate(Request $request){

	 	$response = DB::table('media_files')
			->where('id', $request->fileid)
			->update(array('type' => $request->typeid));	    
		if($response){
			echo 'success';
		}
		else {
			echo 'fail';
		}
		exit;
	}

	public function duplicatranche(Request $request)
	{
		$tranche = DB::table('tranche')
					->where('id', $request->id)
					->first();
					
		$id = DB::table('tranche')->insertGetId([
            'user_id' => $request->user()->id,
            'id_disposizione' => $tranche->id_disposizione,
			'tipo' => $tranche->tipo,
			'datainserimento' => $tranche->datainserimento,
			'datascadenza' => $tranche->datascadenza,
			'percentuale' => $tranche->percentuale,
			'dettagli' => $tranche->dettagli,
			'frequenza' => $tranche->frequenza,
			'DA' => $tranche->DA,
			'A' => $tranche->A,
			'idfattura' => $tranche->idfattura,
			'emissione' => $tranche->emissione,
			'indirizzospedizione' => $tranche->indirizzospedizione,
			'privato' => $tranche->privato,
			'base' => $tranche->base,
			'modalita' => $tranche->modalita,
			'iban' => $tranche->iban,
			'peso' => $tranche->peso,
			'netto' => $tranche->netto,
			'scontoaggiuntivo' => $tranche->scontoaggiuntivo,
			'imponibile' => $tranche->imponibile,
			'prezzoiva' => $tranche->prezzoiva,
			'percentualeiva' => $tranche->percentualeiva,
			'dapagare' => $tranche->dapagare,
        ]);
		

		$logs = $this->logmainsection.' -> Copy(Duplicate) Invoice (ID: '. $id . ')';
		storelogs($request->user()->id, $logs);

		$items = DB::table('corpofattura')
            ->where('id_tranche', $request->id)
            ->get();

        foreach($items as $item) {
            DB::table('corpofattura')->insert([
				'id_tranche' => $id,
				'ordine' => $item->ordine,
				'descrizione' => $item->descrizione,
				'qta' => $item->qta,
				'subtotale' => $item->subtotale,
				'scontoagente' => $item->scontoagente,
				'scontobonus' => $item->scontobonus,
				'netto' => $item->netto,
				'percentualeiva' => $item->percentualeiva
			]);
        }

		return Redirect::back()
                       ->with('error_code', 5)
                       ->with('msg', '<div class="alert alert-info"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a> '.trans('messages.keyword_duplicatesuccessmsg').' !</div>');
	}


	public function eliminatranche(Request $request)
	{
        DB::table('tranche')
			->where('id', $request->id)
			->update(array(
				'is_deleted' => 1	
		));		

		$logs = $this->logmainsection.' -> Delete Invoice -> (ID: '. $request->id . ')';
		storelogs($request->user()->id, $logs);

		return Redirect::back()
            ->with('error_code', 5)
            ->with('msg', '<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a> '.trans('messages.keyword_deletesuccessmsg').' !</div>');
	}


	/* =========================  Provisions Functions ========================= */
	
	public function index(Request $request)
	{
		if ($request->user()->id === 0 || $request->user()->dipartimento !== 3) {		
			$data = DB::table('projects')
    			->join('users', 'projects.user_id', '=', 'users.id')
    			->join('accountings', 'projects.id', '=', 'accountings.id_progetto')	
    			->select(DB::raw('projects.*, users.id as uid, users.is_delete,accountings.nomeprogetto as groupname,accountings.id as groupid'))
				->where('is_deleted','0')
				->where('users.is_delete', '=', 0)
				->orderBy('projects.id', 'asc')
				->get();			

            return view('pagamenti.main', [
				'progetti' => $this->progetti->forUser2($request->user()), 
				'dipartimenti' => DB::table('departments')->get(),
				'quadri' => DB::table('accountings')->get(),
				'groupdetails'=>$data
			]);
        } else {        	
			return view('errors.403');
		}
	}

	public function getjson(Request $request)
	{
		$pagamenti = $this->pagamenti->forUser($request->user());
		
		//$this->compila($pagamenti);
		return json_encode($pagamenti);
	}

	public function compila(&$pagamenti)
	{
		foreach($pagamenti as $pagamento) {
			$progetto = DB::table('projects')
				->get();
			foreach($progetto as $prog) {
				if($prog->id == $pagamento->id_progetto) {
					$pagamento->id_progetto = $prog->nomeprogetto;
					if($prog->id_ente != null)
						$pagamento->ente = DB::table('corporations')
							->where('id', $prog->id_ente)
							->first()->nomeazienda;
					break;
				}	
			}
		}
	}

	public function creadisposizione(Request $request)
	{
		$validator = Validator::make($request->all(), [
            'nomeprogetto' => 'required|max:50',
            'idprogetto' => 'required'
        ]);        
        
        if($validator->fails()) {
            return Redirect::back()
                ->withInput()
                ->with('error_code', 6)
                ->withErrors($validator);
        }
		
		$progetto = DB::table('accountings')->insertGetId([
                        'user_id' => $request->user()->id,
                        'nomeprogetto' => $request->nomeprogetto,
						'id_progetto' => $request->idprogetto,
                      ]);
		
		$logs = $this->logmainsection.' -> Add New Provision -> (ID: '. $progetto . ')';
		storelogs($request->user()->id, $logs);

		return Redirect::back()
            ->with('error_code', 5)
            ->with('msg', '<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'.trans('messages.keyword_addsuccessmsg').'!</div>');
	}


	public function modificadisposizione(Request $request, Accounting $accounting)
	{
		$this->authorize('modify', $accounting);
       $validator = Validator::make($request->all(), [
            'nomeprogetto' => 'required|max:50',
        ]);
        
        
        if($validator->fails()) {
            return Redirect::back()
                ->withInput()
                ->with('error_code', 6)
                ->withErrors($validator);
        }
		
        $results = DB::table('accountings')
			->where('id', $accounting->id)
			->update(array(
				'nomeprogetto' => $request->nomeprogetto
				/*'id_progetto' => $request->idprogetto,*/
        	));
        $logs = $this->logmainsection.' -> Update Provision -> (ID: '. $accounting->id . ')';
		storelogs($request->user()->id, $logs);
		return "true";
		/*if($results) {
			return "true";
		}
		else {
			return "false";	
		}*/
		/*return Redirect::back()
                        ->with('error_code', 5)
                        ->with('msg', '<div class="alert alert-info"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a> '.trans('messages.keyword_editsuccessmsg').' !</div>');*/
	}

	public function duplicadisposizione(Request $request, Accounting $accounting)
	{
		$this->authorize('duplicate', $accounting);
        
        $did = DB::table('accountings')->insertGetId([
            'user_id' => $request->user()->id,
            'nomeprogetto' => $accounting->nomeprogetto,
			'id_progetto' => $accounting->idprogetto,
        ]);
		
		$logs = $this->logmainsection.' -> Copy(Duplicate) Disposal -> (ID: '. $did . ')';
		storelogs($request->user()->id, $logs);

		return Redirect::back()
            ->with('error_code', 5)
            ->with('msg', '<div class="alert alert-info"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'.trans('messages.keyword_duplicatesuccessmsg').'!</div>');
	}

	public function destroydisposizione(Request $request, Accounting $accounting)
	{
		$this->authorize('destroy', $accounting);
		
		DB::table('tranche')
			->where('id_disposizione', $accounting->id)
			->delete();
		
		$accounting->delete();
		
		$logs = $this->logmainsection.' -> Delete Disposal -> (ID: '. $accounting->id . ')';
		storelogs($request->user()->id, $logs);

		return Redirect::back()
	        ->with('error_code', 5)
	        ->with('msg', '<div class="alert alert-info"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'.trans('messages.keyword_deletesuccessmsg').'!</div>');
	}

	public function mostracoordinate(Request $request){
		
		return view('pagamenti.coordinate');	
	}


	/* =========================  Stat Functions ========================= */

	public function mostrastatistiche(Request $request)
	{
		$request->anno = date('Y');
		return $this->statisticheeconomiche($request);
	}

	public function statisticheeconomiche(Request $request)
	{
		if ($request->user()->id === 0 || $request->user()->dipartimento === 1 || $request->user()->dipartimento === 2) {

			$guadagno = []; $ricavi = []; $spese = [];

			$this->compilaSpese($spese, $request->anno);
			$this->compilaRicavi($ricavi, $request->anno);
			$this->calcolaGuadagno($guadagno, $ricavi, $spese);

			$month = array(
					''.trans("messages.keyword_january").'',
					''.trans("messages.keyword_february").'',
					''.trans("messages.keyword_march").'',
					''.trans("messages.keyword_april").'',
					''.trans("messages.keyword_may").'',
					''.trans("messages.keyword_june").'',
					''.trans("messages.keyword_july").'',
					''.trans("messages.keyword_august").'',
					''.trans("messages.keyword_september").'',
					''.trans("messages.keyword_october").'',
					''.trans("messages.keyword_november").'',
					''.trans("messages.keyword_december").'' );

			$statistics = array('month' => $month, 'revenue' => $ricavi, 'expense' => $spese, 'earn' => $guadagno);

			return view('statistiche', [
				'statistics' =>$statistics,
				'anno' => $request->anno
			]);

		} else
			return redirect('/unauthorized');
	}

	public function compilaSpese(&$spese, $anno)
	{
		for($i = 1; $i <= 12; $i++) {
			if($i < 10)
				$i = '0' . $i;			
			$spese[] = $this->calcola($this->query($i, $anno));
		}
	}

	public function query($mese, $anno)
	{	
		$spese = DB::table('costi')->get();	
		$spese_array = [];
		foreach($spese as $spesa) {
			$spesa_mese = substr($spesa->datainserimento, 5, 2);			
			$spesa_anno = substr($spesa->datainserimento, 0, 4);			
			if($spesa_mese == $mese && $spesa_anno == $anno)
				$spese_array[] = $spesa->costo;
		}	
		return $spese_array;
	}

	public function calcola($spese)
	{				
		$totale = 0;
		for($i = 0; $i < count($spese); $i++)
			$totale += $spese[$i];

		return $totale;	
	}

	public function compilaRicavi(&$ricavi, $anno)
	{
		for($i = 1; $i <= 12; $i++) {
			if($i < 10)
				$i = '0' . $i;
			$ricavi[] = $this->calcolaRicavi($this->queryRicavi($i, $anno));
		}
	}

	public function queryRicavi($mese, $anno)
	{
		$ricavi = DB::table('tranche')->where('privato', 0)->get();
		$utenti = DB::table('users')->get();
		$ricavi_array = [];

		foreach($ricavi as $ricavo) {
			$ricavo_mese = substr($ricavo->datainserimento, 5, 2);
			$ricavo_anno = substr($ricavo->datainserimento, 0, 4);

			// Check if the one who made the tranche is a commercial one,
			// If yes, then I have to count the revenue as a expense (-)
			for($i = 0; $i < count($utenti); $i++) {
				if($utenti[$i]->id == $ricavo->user_id) {
					if($utenti[$i]->dipartimento === 2) {
						$ricavo->imponibile *= -1;
					}
					break;	
				}	
			}
			if($ricavo_mese == $mese && $ricavo_anno == $anno)
				$ricavi_array[] = $ricavo->imponibile;
		}
		return $ricavi_array;
	}

	public function calcolaRicavi($spese)
	{
		$totale = 0;
		for($i = 0; $i < count($spese); $i++)
			$totale += $spese[$i];
		return $totale;	
	}

	public function calcolaGuadagno(&$guadagno, $ricavi, $spese)
	{		
		for($i = 0; $i < 12; $i++) {
			$guadagno[] = $ricavi[$i] + $spese[$i];
		}	
	}


	// ==================  Start Date Range ======================= // 

	public function statisticheeconomichedate(Request $request)
	{
		if ($request->user()->id === 0 || $request->user()->dipartimento === 1 || $request->user()->dipartimento === 2) {

			$guadagno = []; $ricavi = [];	$spese = [];
			$spece_date = []; $ricavi_date = []; $guadagno_date = [];

			$month = array(
				''.trans("messages.keyword_january").'', 
				''.trans("messages.keyword_february").'',
				''.trans("messages.keyword_march").'',
				''.trans("messages.keyword_april").'',
				''.trans("messages.keyword_may").'',
				''.trans("messages.keyword_june").'',
				''.trans("messages.keyword_july").'',
				''.trans("messages.keyword_august").'',
				''.trans("messages.keyword_september").'',
				''.trans("messages.keyword_october").'',
				''.trans("messages.keyword_november").'',
				''.trans("messages.keyword_december").'' );

			// $month = array("1" => "Jan", "2" => "Feb", "3" => "Mar", "4" => "Apr", "5" => "May", "6" => "Jun" , "7" => "July", "8" => "Aug", "9" => "Sep", "10" => "Oct", "11" => "Nov", "12" => "Dec");

			$this->compilaSpeseDate($spese, $request->date, $spece_date);
			$this->compilaRicaviDate($ricavi, $request->date, $ricavi_date);
			$this->calcolaGuadagnoDate($guadagno, $ricavi_date, $spece_date, $guadagno_date);

			if($guadagno_date) {
				foreach ($guadagno_date as $key => $value) {

					if(array_key_exists($key, $ricavi_date)){
						$ricavi_date[$key] =  $ricavi_date[$key];
						$revenue[] =  $ricavi_date[$key];
					} else {
						$ricavi_date[$key] = 0; $revenue[] = 0;
					}
					if(array_key_exists($key, $spece_date)){					
						$spece_date[$key] =  $spece_date[$key];
						$expense[] =  $spece_date[$key];
					} else {
						$spece_date[$key] = 0; $expense[] = 0;
					}

					$year = substr($key, 0, 4);
					$mon = substr($key, 5, 2);		

					for ($i=1; $i <=12 ; $i++) {						
						if($mon == $i){ $date_month[] = $month[$i]." / ".$year; }
					}
					ksort($spece_date); ksort($ricavi_date);
					$earn[] = $value;		
				}
				$statistics = array('month' => $date_month, 'revenue' => $revenue, 'expense' => $expense, 'earn' => $earn);
				unset($guadagno); unset($ricavi); unset($spese);
				unset($spece_date); unset($ricavi_date); unset($guadagno_date);	

			} else {
				$revenue = array(0,0,0,0,0,0,0,0,0,0,0,0);
				$expense = array(0,0,0,0,0,0,0,0,0,0,0,0);
				$earn = array(0,0,0,0,0,0,0,0,0,0,0,0);
				$statistics = array('month' => $month, 'revenue' => $revenue, 'expense' => $expense, 'earn' => $earn);
			}		
			return view('statistics-date', [
				'statistics' => $statistics,
				'anno' => date("Y")
			]);
		} else
			return redirect('/unauthorized');
	}

	public function compilaSpeseDate(&$spese, $date, &$spece_date)
	{	
		$spece_date = $this->queryDate($date);
		$spese = [];

		foreach ($spece_date as $key => $value) {			
			$spese[] = $value;
		}	
	}

	public function queryDate($date)
	{			
		$fromdate = substr($date, 0, 10);
		$todate = substr($date, 22, 10);

		$date = str_replace('-', '/', $fromdate);
		$fromdate = date("Y-m-d", strtotime($date));

		$date = str_replace('-', '/', $todate);
		$todate = date("Y-m-d", strtotime($date));

		$spese = DB::table('costi')
			->whereBetween('datainserimento', [$fromdate, $todate])
			->orderBy('datainserimento')->get();
		
		if($spese){

			$spese_array = []; $mese = [];

			foreach($spese as $spesa) {

				$spesa_mese = substr($spesa->datainserimento, 0, 7);

				if(in_array($spesa_mese, $mese)){
					$spese_array[$spesa_mese] += floatval($spesa->costo);			
				} else {
					$spese_array[$spesa_mese] = floatval($spesa->costo);
				}

				$mese[] = $spesa_mese;			
			}

			unset($mese);
			return $spese_array;

		} else {
			return $spese_array = [];
		}
		
	}
	
	public function compilaRicaviDate(&$ricavi, $date, &$ricavi_date)
	{		
		$ricavi_date =$this->queryRicaviDate($date);
		$ricavi = [];

		foreach ($ricavi_date as $value) {
			$ricavi[] = $value;	
		}	
	}

	public function queryRicaviDate($date)
	{
		$fromdate = substr($date, 0, 10);
		$todate = substr($date, 22, 10);

		$date = str_replace('-', '/', $fromdate);
		$fromdate = date("Y-m-d", strtotime($date));
		
		$date = str_replace('-', '/', $todate);
		$todate = date("Y-m-d", strtotime($date));

		$ricavi = DB::table('tranche')
			->whereBetween('datainserimento', [$fromdate, $todate])
			->where('privato', 0)->orderBy('datainserimento')->get();

		$ricavi_array = []; $mese = [];

		$utenti = DB::table('users')->get();

		foreach($ricavi as $ricavo) {			

			for($i = 0; $i < count($utenti); $i++) {
				if($utenti[$i]->id == $ricavo->user_id) {					
					if($utenti[$i]->dipartimento === 2) {
						$ricavo->imponibile *= -1;
					}
					break;	
				}	
			}

			$ricavi_mese = substr($ricavo->datainserimento, 0, 7);

			if(in_array($ricavi_mese, $mese)){
				$ricavi_array[$ricavi_mese] += floatval($ricavo->imponibile);
			} else {
				$ricavi_array[$ricavi_mese] = floatval($ricavo->imponibile);
			}

			$mese[] = $ricavi_mese;	
		}

		unset($mese);
		return $ricavi_array;
	}

	public function calcolaGuadagnoDate(&$guadagno, $ricavi_date, $spece_date, &$guadagno_date)
	{	
		if(count($spece_date) > count($ricavi_date)){
			foreach ($spece_date as $spece_key => $spece_value) {	
				if(array_key_exists($spece_key, $ricavi_date)){					
					$earn[$spece_key] =  $spece_value + $ricavi_date[$spece_key];
				} else {
					$earn[$spece_key] = $spece_value;
				}						
			}

			$ricavi = array_diff_key($ricavi_date, $earn);
			$guadagno_date = array_merge($earn, $ricavi);

		} else if(count($spece_date) < count($ricavi_date)){
			foreach ($ricavi_date as $ricavi_key => $ricavi_value) {	

				if(array_key_exists($ricavi_key, $spece_date)){					
					$earn[$ricavi_key] =  $ricavi_value + $spece_date[$ricavi_key];
				} else {
					$earn[$ricavi_key] = $ricavi_value;
				}						
			}

			$spese = array_diff_key($spece_date, $earn);
			$guadagno_date = array_merge($earn, $spese);

		} else {
			$earn = [];
		}

		foreach ($guadagno_date as $value) {
			$guadagno[] = $value;
		}
	}

	// ==================  End Date Range ======================= // 


	public function getjsoncosti(Request $request)
	{
		$costi = DB::table('costi')->get();
		$costi = $this->aggiungiNomeEnte($costi, $request->user());
		return json_encode($costi);
	}

	public function aggiungiNomeEnte(&$costi, $user)
	{
		$elenco_costi = [];
		foreach($costi as $costo) {
			$ente = DB::table('corporations')
							->where('id', $costo->id_ente)
							->first();
			$costo->ente = $ente->nomeazienda;
			if ($user->id === 0 || $user->dipartimento === 1) {
				$elenco_costi[] = $costo;
			} else if($user->id == $tra->user_id) {
				$elenco_costi[] = $costo;	
			}
		}
		return $elenco_costi;
	}

	public function modificacosto(Request $request)
	{
		$costo = DB::table('costi')
					->where('id', $request->id)
					->first();
		return view('modificacosto', [
			'costo' => $costo,
			'enti' => DB::table('corporations')->get()
		]);	
	}

	public function aggiornacosto(Request $request)
	{		
		$validator = Validator::make($request->all(), [
			'oggetto' => 'required',
			'costo' => 'required',
			'datainserimento' => 'required'
		]);
		
		if($validator->fails()) {
			return Redirect::back()
				->withInput()
				->withErrors($validator);
		}

		DB::table('costi')
			->where('id', $request->id)
			->update(array(
				'oggetto' => $request->oggetto,
				'costo' => $request->costo,
				'datainserimento' => $request->datainserimento,
				'id_ente' => $request->ente
			));
		return Redirect::back()
			->with('msg', '<div class="alert alert-info"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'.trans('messages.keyword_editsuccessmsg').'!</div>');
	}

	public function destroycosto(Request $request)
	{
		DB::table('costi')
			->where('id', $request->id)
			->delete();

		return Redirect::back()
			->with('msg', '<div class="alert alert-info"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'.trans('messages.keyword_deletesuccessmsg').'!</div>');
	}
}
